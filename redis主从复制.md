
什么是主从复制?
为了保证主数据和从数据一致。
- 高可用：不然当发生故障切换，会导致数据丢失
- 负载均衡：从节点可以用来处理读请求


redis是异步同步的，因此属于AP。为了保证最终一致性，从节点会努力追上主节点数据。 这有两个情况， 短同步和长同步（断联）

主从复制原理：
1. 启动多个节点
2. 配置主从节点，建立socket连接
3. 发生Ping命令
4. 权限验证
5. 数据全量同步
6. 命令持续复制

### 同步过程

分为全复制和半复制。

#### 全复制
全同步需要将所有数据同步给从节点，性能比较差，影响比较大，过程如下
（1）从节点判断无法进行部分复制，向主节点发送全量复制的请求；或从节点发送部分复制的请求，但主节点判断无法进行部分复制；
（2）主节点收到全量复制的命令后，执行bgsave，在后台生成RDB文件，并使用一个缓冲区（称为复制缓冲区）记录从现在开始执行的所有写命令
（3）主节点的bgsave执行完成后，将RDB文件发送给从节点；从节点首先清除自己的旧数据，然后载入接收的RDB文件，将数据库状态更新至主节点执行bgsave时的数据库状态
（4）主节点将复制缓冲区中的所有写命令发送给从节点，从节点执行这些写命令，将数据库状态更新至主节点的最新状态
（5）如果从节点开启了AOF，则会触发bgrewriteaof的执行，从而保证AOF文件更新至主节点的最新状态

全同步缺点：
- 主节点需要导出RDB文件，占用IO资源
- 主节点需要将RDB文件发送给从节点，占用网络资源
 - 从节点需要情况数据库，并且导入RDB文件后执行

#### 半复制

主备建立第一次经过全量复制后，后续主节点只需要将写命令持续复制给从节点执行即可。但这个过程可能有异常
再次全同步发生场景： 命令持续复制过程中出现异常，断链网络中断等原因，导致从节点数据差距过大，无法通过半复制来实现同步

redis为了提升主备复制效率，实现了部分复制
- 复制缓冲区
- 复制偏移记录
- 节点运行ID

节点运行ID：用于明确每个节点的ID
复制缓冲区： 是一个FIFO链表的缓存区，用于存储主节点最近的写命令
复制偏移记录用于记录主从同步偏移进度


半复制过程：
主节点执行完写命令会将命令放入复制缓冲区中，同时更新自己的复制偏移量N字节，从节点接收到复制命令，执行写入命令后，也会更新字节的复制偏移量+N字节。

如果主偏移量大于从偏移量，说明从节点落后主节点数据，需要同步这个区间的数据

复制缓冲区也不能是无限大的，通过设置`repl-backlog-size`
的大小来控制，他是FIFO的链表结构，超过这个大小的同步命令会被移除，如果从节点的偏移量大于这个size，则历史数据无法同步了，只能走全同步了

#### 同步控制机制

如果从节点online的数量少于设定的数量，主节点会拒绝写操作。通过这种操作来控制主备延迟的时间范围。

从节点online的判断，通过ping间隔的时间做判断，一般情况下主从每秒会ping。当主节点收到上次从节点的pong回复大于等于一个delay阈值，则会认为备节点offline

这个配置无法保证从节点会在这个delay中是否接受写请求，但至少能说明这个范围外，肯定是没有的。

配置如下
`min-replicas-to-write`: 表示最小online的备节点数量，主节点能执行写请求
`min-replicas-max-lag`: 表示从节点offline的最大时间间隔

```
# min-replicas-to-write 3
# min-replicas-max-lag 10
```




## 问题

### 备节点用于读
#### 主备延迟问题

从节点同步是异步的，期间有命令传输和执行的同步时间延迟，这个延迟可能导致短暂的数据不一致。

一般情况下从节点是设置不可读的，读也走主节点，保证数据准确，但为了分担压力，可以设定读只读，但要考虑主备延迟

可以通过配置slave-serve-stale-data，加快主备传输速度。或通过提高网络速度来提高命令传播速度

#### 数据过期问题

过期的数据，从节点不会主动删除，而是等
#### 复制超时问题

## 应用

### info replication命令输出解释
以下是对 Redis 主从复制相关配置项的详细解释：

1. role:slave

含义：表示当前 Redis 实例的角色。
    
值：slave 表示当前实例是从服务器（从节点）。
    

2. master_host:redis-master

含义：主服务器的主机名或 IP 地址。
    
值：redis-master 是主服务器的主机名或 IP 地址。
    

3. master_port:6379

含义：主服务器的端口号。
    
值：6379 是主服务器的 Redis 服务端口。
    

4. master_link_status:up

含义：主从链路的状态。
    
值：
    
    up：主从链路正常，从服务器可以连接到主服务器。
        
    down：主从链路断开，从服务器无法连接到主服务器。
        

5. master_last_io_seconds_ago:10

含义：从服务器上次与主服务器进行 I/O 操作的时间（秒）。
    
值：10 表示从服务器上次与主服务器进行 I/O 操作的时间是 10 秒前。
    

6. master_sync_in_progress:0

含义：是否正在进行主从同步。
    
值：
    0：表示主从同步已完成或未进行。  
    1：表示主从同步正在进行中。
        

7. slave_read_repl_offset:28

含义：从服务器读取的复制偏移量。
    
值：28 表示从服务器读取的复制偏移量为 28。
    

8. slave_repl_offset:28

含义：从服务器的复制偏移量。
    
值：28 表示从服务器的复制偏移量为 28。
    

9. slave_priority:100

含义：从服务器的优先级。
    
值：100 是默认值，表示从服务器的优先级。在故障转移时，优先级越低的从服务器越有可能被选为新的主服务器。
    

10. slave_read_only:1

含义：从服务器是否只读。
    
值：
    
    1：表示从服务器是只读的。
        
    0：表示从服务器不是只读的。
        

11. replica_announced:1

含义：是否已向主服务器宣布为从服务器。
    
值：
    
    1：表示已向主服务器宣布为从服务器。
        
    0：表示未向主服务器宣布为从服务器。
        

12. connected_slaves:0

含义：连接到当前从服务器的从服务器数量。
    
值：0 表示没有从服务器连接到当前从服务器。
    

13. master_failover_state:no-failover

含义：主服务器的故障转移状态。
    
值：no-failover 表示当前没有进行故障转移。
    

14. master_replid:752a583a5eaad8c18e38478432b6ffb77044a0b6

含义：主服务器的复制 ID。
    
值：752a583a5eaad8c18e38478432b6ffb77044a0b6 是主服务器的复制 ID，用于标识主服务器的复制状态。
    

15. master_replid2:0000000000000000000000000000000000000000

含义：主服务器的第二个复制 ID。
    
值：0000000000000000000000000000000000000000 是一个默认值，表示当前没有使用第二个复制 ID。
    

16. master_repl_offset:28

含义：主服务器的复制偏移量。
    
值：28 表示主服务器的复制偏移量为 28。
    

17. second_repl_offset:-1

含义：第二个复制 ID 的偏移量。
    
值：-1 表示当前没有使用第二个复制 ID，因此偏移量无效。
    

18. repl_backlog_active:1

含义：复制积压缓冲区是否激活。
    
值：
    
    1：表示复制积压缓冲区已激活。
        
    0：表示复制积压缓冲区未激活。
        

19. repl_backlog_size:1048576

含义：复制积压缓冲区的大小。
    
值：1048576 表示复制积压缓冲区的大小为 1MB。
    

20. repl_backlog_first_byte_offset:1

含义：复制积压缓冲区的第一个字节偏移量。
    
值：1 表示复制积压缓冲区的第一个字节偏移量为 1。
    

21. repl_backlog_histlen:28

含义：复制积压缓冲区中存储的历史数据长度。
    
值：28 表示复制积压缓冲区中存储的历史数据长度为 28 字节。
    

总结

这些配置项提供了关于 Redis 主从复制状态的详细信息，包括主从链路状态、复制偏移量、复制积压缓冲区等。通过这些信息，可以监控和调试主从复制的运行状态，确保数据同步的正确性和稳定性。